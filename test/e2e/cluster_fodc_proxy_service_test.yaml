# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# E2E test for FODC proxy service functionality

setup:
  env: kind
  file: kind.yaml
  init-system-environment: env
  steps:
    - name: set PATH
      command: export PATH=/tmp/skywalking-infra-e2e/bin:$PATH
    - name: install yq
      command: bash test/e2e/setup-e2e-shell/install.sh yq
    - name: install kubectl
      command: bash test/e2e/setup-e2e-shell/install.sh kubectl
    - name: Install helm
      command: bash test/e2e/setup-e2e-shell/install.sh helm
    - name: Install dependency
      command: |
        helm repo add bitnami https://charts.bitnami.com/bitnami
        cd chart
        helm dependency update
    - name: Install BanyanDB with FODC proxy
      command: |
        cd chart
        helm install banyandb-fodc-test . \
          --set cluster.enabled=true \
          --set cluster.fodcProxy.enabled=true \
          --set cluster.fodcProxy.grpcSvc.port=17904 \
          --set cluster.fodcProxy.httpSvc.port=17905 \
          --set cluster.fodcProxy.httpSvc.type=LoadBalancer \
          --set cluster.fodcAgent.enabled=true \
          --set cluster.data.enabled=true \
          --set cluster.data.replicas=1 \
          --set cluster.liaison.enabled=true \
          --set cluster.liaison.replicas=1 \
          --set etcd.enabled=true \
          --set etcd.replicaCount=1 \
          --set image.tag=latest
      wait:
        - namespace: default
          resource: pod
          for: condition=ready
          label-selector: app.kubernetes.io/name=banyandb
        - namespace: default
          resource: service
          for: exists
          name: banyandb-fodc-test-fodc-proxy-grpc
        - namespace: default
          resource: service
          for: exists
          name: banyandb-fodc-test-fodc-proxy-http
  timeout: 15m

verify:
  retry:
    count: 10
    interval: 30s
  cases:
    # Verify FODC proxy gRPC service exists and is accessible
    - query: kubectl get service banyandb-fodc-test-fodc-proxy-grpc -o yaml
      expected: expected/fodc-proxy-grpc-service.yml

    # Verify FODC proxy HTTP service exists and is accessible
    - query: kubectl get service banyandb-fodc-test-fodc-proxy-http -o yaml
      expected: expected/fodc-proxy-http-service.yml

    # Verify FODC proxy deployment exists
    - query: kubectl get deployment banyandb-fodc-test-fodc-proxy -o yaml
      expected: expected/fodc-proxy-deployment.yml

    # Verify FODC proxy pods are running
    - query: kubectl get pods -l app.kubernetes.io/component=fodc-proxy -o yaml
      expected: expected/fodc-proxy-pods.yml

    # Verify FODC agent sidecars are running in data nodes
    - query: kubectl get pods -l app.kubernetes.io/component=data -o yaml
      expected: expected/fodc-agent-sidecars.yml

    # Test FODC proxy gRPC endpoint connectivity
    - query: |
        kubectl run test-client --image=curlimages/curl --rm -i --restart=Never -- \
          curl -v --connect-timeout 10 grpc://banyandb-fodc-test-fodc-proxy-grpc:17904/health 2>&1 | head -20
      expected: expected/fodc-proxy-grpc-connectivity.yml

    # Test FODC proxy HTTP endpoint connectivity
    - query: |
        kubectl run test-client --image=curlimages/curl --rm -i --restart=Never -- \
          curl -v --connect-timeout 10 http://banyandb-fodc-test-fodc-proxy-http:17905/health 2>&1 | head -20
      expected: expected/fodc-proxy-http-connectivity.yml

    # Verify FODC agent metrics endpoint
    - query: |
        kubectl exec -it $(kubectl get pods -l app.kubernetes.io/component=data -o jsonpath='{.items[0].metadata.name}') \
          -- curl -s http://localhost:17915/metrics | head -10
      expected: expected/fodc-agent-metrics.yml
