suite: test cluster_fodc_proxy_service template
templates:
  - templates/cluster_fodc_proxy_service.yaml
  - templates/_helpers.tpl
tests:
  - it: should not render services when cluster is disabled
    template: cluster_fodc_proxy_service.yaml
    set:
      cluster.enabled: false
      cluster.fodcProxy.enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render services when fodcProxy is disabled
    template: cluster_fodc_proxy_service.yaml
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render gRPC service when grpcSvc is configured
    template: cluster_fodc_proxy_service.yaml
    documentIndex: 0
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17904
        labels: {}
        annotations: {}
    asserts:
      - isKind:
          of: Service
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-banyandb-fodc-proxy-grpc
      - equal:
          path: spec.type
          value: ClusterIP
      - equal:
          path: spec.ports[0].port
          value: 17904
      - equal:
          path: spec.ports[0].name
          value: grpc
      - equal:
          path: spec.ports[0].targetPort
          value: grpc

  - it: should render HTTP service when httpSvc is configured
    template: cluster_fodc_proxy_service.yaml
    documentIndex: 1
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17904
      cluster.fodcProxy.httpSvc:
        port: 17905
        type: LoadBalancer
        labels: {}
        annotations: {}
    asserts:
      - isKind:
          of: Service
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-banyandb-fodc-proxy-http
      - equal:
          path: spec.type
          value: LoadBalancer
      - equal:
          path: spec.ports[0].port
          value: 17905
      - equal:
          path: spec.ports[0].name
          value: http
      - equal:
          path: spec.ports[0].targetPort
          value: http

  - it: should render only gRPC service when httpSvc is not configured
    template: cluster_fodc_proxy_service.yaml
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17904
      cluster.fodcProxy.httpSvc: null
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-banyandb-fodc-proxy-grpc

  - it: should render only HTTP service when grpcSvc is not configured
    template: cluster_fodc_proxy_service.yaml
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.httpSvc:
        port: 17905
        type: ClusterIP
      cluster.fodcProxy.grpcSvc: null
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-banyandb-fodc-proxy-http

  - it: should set HTTP service type to ClusterIP
    template: cluster_fodc_proxy_service.yaml
    documentIndex: 1
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17904
      cluster.fodcProxy.httpSvc:
        port: 17905
        type: ClusterIP
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP

  - it: should set HTTP service type to NodePort
    template: cluster_fodc_proxy_service.yaml
    documentIndex: 1
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17904
      cluster.fodcProxy.httpSvc:
        port: 17905
        type: NodePort
    asserts:
      - equal:
          path: spec.type
          value: NodePort

  - it: should include externalIPs in HTTP service when configured
    template: cluster_fodc_proxy_service.yaml
    documentIndex: 1
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17904
      cluster.fodcProxy.httpSvc:
        port: 17905
        type: LoadBalancer
        externalIPs:
          - "192.168.1.100"
          - "192.168.1.101"
    asserts:
      - equal:
          path: spec.externalIPs[0]
          value: "192.168.1.100"
      - equal:
          path: spec.externalIPs[1]
          value: "192.168.1.101"

  - it: should include loadBalancerIP in HTTP service when configured
    template: cluster_fodc_proxy_service.yaml
    documentIndex: 1
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17904
      cluster.fodcProxy.httpSvc:
        port: 17905
        type: LoadBalancer
        loadBalancerIP: "10.0.0.100"
    asserts:
      - equal:
          path: spec.loadBalancerIP
          value: "10.0.0.100"

  - it: should include loadBalancerSourceRanges in HTTP service when configured
    template: cluster_fodc_proxy_service.yaml
    documentIndex: 1
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17904
      cluster.fodcProxy.httpSvc:
        port: 17905
        type: LoadBalancer
        loadBalancerSourceRanges:
          - "10.0.0.0/8"
          - "172.16.0.0/12"
    asserts:
      - equal:
          path: spec.loadBalancerSourceRanges[0]
          value: "10.0.0.0/8"
      - equal:
          path: spec.loadBalancerSourceRanges[1]
          value: "172.16.0.0/12"

  - it: should not include externalIPs when not configured
    template: cluster_fodc_proxy_service.yaml
    documentIndex: 1
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17904
      cluster.fodcProxy.httpSvc:
        port: 17905
        type: LoadBalancer
    asserts:
      - notExists:
          path: spec.externalIPs

  - it: should not include loadBalancerIP when not configured
    template: cluster_fodc_proxy_service.yaml
    documentIndex: 1
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17904
      cluster.fodcProxy.httpSvc:
        port: 17905
        type: LoadBalancer
    asserts:
      - notExists:
          path: spec.loadBalancerIP

  - it: should not include loadBalancerSourceRanges when not configured
    template: cluster_fodc_proxy_service.yaml
    documentIndex: 1
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17904
      cluster.fodcProxy.httpSvc:
        port: 17905
        type: LoadBalancer
    asserts:
      - notExists:
          path: spec.loadBalancerSourceRanges

  - it: should use custom port for gRPC service
    template: cluster_fodc_proxy_service.yaml
    documentIndex: 0
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17999
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 17999

  - it: should use custom port for HTTP service
    template: cluster_fodc_proxy_service.yaml
    documentIndex: 1
    set:
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17904
      cluster.fodcProxy.httpSvc:
        port: 8080
        type: ClusterIP
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 8080

  - it: should handle fullnameOverride correctly
    template: cluster_fodc_proxy_service.yaml
    documentIndex: 0
    set:
      fullnameOverride: "custom-name"
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17904
    asserts:
      - equal:
          path: metadata.name
          value: custom-name-fodc-proxy-grpc

  - it: should handle nameOverride correctly
    template: cluster_fodc_proxy_service.yaml
    documentIndex: 0
    set:
      nameOverride: "custom"
      cluster.enabled: true
      cluster.fodcProxy.enabled: true
      cluster.fodcProxy.grpcSvc:
        port: 17904
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-custom-fodc-proxy-grpc
